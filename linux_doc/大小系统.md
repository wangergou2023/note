

# ğŸ§  8MBå¤§å°ç³»ç»Ÿæ„æ€æ€»ç»“

## ğŸ§± 8MB Flash åˆ†åŒºå¸ƒå±€

| åˆ†åŒºå    | å¤§å°  | åˆ†åŒºé•œåƒ        |
| --------- | ----- | --------------- |
| `uboot`   | 256KB | uboot.bin       |
| `env`     | 64KB  | env.bin         |
| `kernel`  | 1.5MB | kernel.uImage   |
| `rootfs`  | 1.5MB | rootfs.squashfs |
| `userfsA` | 2MB   | usr.squashfs    |
| `userfsB` | 2MB   | usr.squashfs    |
| `data`    | 192KB | data.jffs2      |

## ğŸ—‚ï¸ åˆ†åŒºå¸ƒå±€è¯´æ˜

| åˆ†åŒºå    | æè¿°                               | æ˜¯å¦å¯å‡çº§ | å¤‡æ³¨                                                         |
| --------- | ---------------------------------- | ---------- | ------------------------------------------------------------ |
| `uboot`   | Bootloaderï¼Œå¼•å¯¼ç³»ç»Ÿå¯åŠ¨           | âœ…          | OTAå¯æ›¿æ¢                                                    |
| `kernel`  | Linux å†…æ ¸                         | âœ…          | OTAå¯æ›¿æ¢                                                    |
| `rootfs`  | å¯åŠ¨æ ¹æ–‡ä»¶ç³»ç»Ÿ                     | âœ…          | OTAå¯æ›¿æ¢                                                    |
| `userfsA` | å½“å‰è¿è¡Œçš„æ­£å¼ç³»ç»Ÿï¼ˆæ–°ç³»ç»Ÿä¸»åˆ†åŒºï¼‰ | âœ…          | OTAå°†æ–°ç³»ç»Ÿå†™å…¥æ­¤åˆ†åŒºï¼Œå‡çº§åä¸»ç³»ç»Ÿè¿è¡Œäºæ­¤                  |
| `userfsB` | OTA æ—¶å†™å…¥ minios é•œåƒ             | âœ…          | minios æ‰§è¡Œå‡çº§ä»»åŠ¡ï¼›å‡çº§å®Œæˆåå†å°† `userfsA` å†…å®¹å¤åˆ¶è¿‡æ¥ä½œä¸ºå¤‡ä»½ |
| `tmp`     | RAM ä¸´æ—¶åŒº                         | -          | å­˜æ”¾ `update_app.bin` å’Œ `ota.img`ï¼Œä¸å ç”¨ Flash ç©ºé—´        |

> ğŸ“Œ å½“å‰è®¾è®¡ **ä¸æ”¯æŒå›æ»š**ï¼šæ—§ `userfs` æ— æ³•å…¼å®¹æ–° `kernel/uboot`ï¼Œé˜²æ­¢ç³»ç»Ÿå¼‚å¸¸ã€‚
>

------

## ğŸ“¦ OTA é•œåƒç»“æ„ï¼ˆota.imgï¼‰

```text
ota.img =
    head.bin              # å›ºå®šå¤´éƒ¨ï¼ˆåŒ…å« offsetã€sizeã€æ ¡éªŒç­‰å…ƒä¿¡æ¯ï¼‰
  + minios.img            # æœ€å°ç³»ç»Ÿï¼ˆå« miniuboot + minikernel(initramfsåŒ…å«download.binä¸‹è½½å™¨)ï¼‰
  + update_app.bin        # ä¸»å‡çº§ç¨‹åºï¼Œç”± download.bin ä¸‹è½½å¹¶æ‰§è¡Œ
  + uboot.bin             # å¾…å†™å…¥çš„æ–° uboot é•œåƒ
  + rootfs.squashfs       # å¾…å†™å…¥çš„æ–° rootfs é•œåƒ
  + kernel.uImage         # å¾…å†™å…¥çš„æ–° kernel é•œåƒ
  + userfs.squashfs       # å¾…å†™å…¥çš„æ–° userfs é•œåƒ
```

------

## ğŸ”„ OTA å‡çº§æµç¨‹

1. ç³»ç»Ÿé‡å¯ â†’ ä» `userfsB` åˆ†åŒºå¯åŠ¨ `minios.img`
2. `minios` è‡ªåŠ¨è¿è¡Œ `download.bin`ï¼š
   - ä¸‹è½½ `ota.img` â†’ `/tmp/ota.img`
   - è§£å‡º `update_app.bin` â†’ `/tmp/update_app.bin`
   - æ‰§è¡Œ `/tmp/update_app.bin`
3. `update_app.bin` æ‰§è¡Œï¼š
   - è§£å‡ºå¹¶å†™å…¥ `uboot.bin` â†’ `uboot` åˆ†åŒº
   - è§£å‡ºå¹¶å†™å…¥ `kernel.uImage` â†’ `kernel` åˆ†åŒº
   - è§£å‡ºå¹¶å†™å…¥ `rootfs.squashfs` â†’ `rootfs` åˆ†åŒº
   - è§£å‡ºå¹¶å†™å…¥ `userfs.squashfs` â†’ `userfsA` åˆ†åŒº
4. é‡å¯å â†’ ä» `userfsA` å¯åŠ¨æ­£å¼æ–°ç³»ç»Ÿ
5. å¯åŠ¨æˆåŠŸ â†’ å°† `userfsA` å†…å®¹å¤åˆ¶ä¸€ä»½åˆ° `userfsB`

------

## âœ… è®¾è®¡ä¼˜åŠ¿æ€»ç»“

- **å°ç³»ç»Ÿåˆ†å·¥æ˜ç¡®**ï¼š
  - `download.bin`ï¼šå¸¸é©»ã€ç¨³å®šï¼Œä»…è´Ÿè´£ä¸‹è½½å™¨
  - `update_app.bin`ï¼šåŠŸèƒ½å®Œæ•´ï¼Œæ”¾åœ¨ `/tmp` èŠ‚çœç©ºé—´
- **å®Œæ•´åˆ†åŒºå‡çº§**ï¼Œå…³é”®åˆ†åŒºå…¨éƒ¨æ›¿æ¢ï¼Œç¡®ä¿ç³»ç»Ÿä¸€è‡´æ€§
- **userfs åŒåˆ†åŒºç»“æ„**ï¼šå‡çº§å‰ååˆ‡æ¢å®‰å…¨ï¼Œæœ‰å¤‡ä»½ä¿éšœ
- **å¼‚å¸¸æ–­ç”µæ¢å¤æœºåˆ¶**ï¼šå‡çº§å¤±è´¥å¯é‡æ–°å¯åŠ¨è¿›å…¥ `minios` é‡è¯•
- **æ— å›æ»šè®¾è®¡**ï¼šé¿å…å†…æ ¸ä¸ç³»ç»Ÿç‰ˆæœ¬ä¸ä¸€è‡´é€ æˆçš„å…¼å®¹æ€§é—®é¢˜
